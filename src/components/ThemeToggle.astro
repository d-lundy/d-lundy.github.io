---
// src/components/ThemeToggle.astro
---

<button class="theme-toggle" id="theme-toggle" type="button" aria-pressed="false" title="Toggle theme">
  <span class="sr-only">Toggle theme</span>
  <svg class="icon icon-moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
  <svg class="icon icon-sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>
</button>

<script is:inline type="module">
(function(){
  const toggle = document.getElementById('theme-toggle');
  if(!toggle) return;
  const root = document.documentElement;
  const STORAGE_KEY = 'dl_theme';

  function updateButtonState(isLight){
    toggle.setAttribute('aria-pressed', String(Boolean(isLight)));
    toggle.title = isLight ? 'Switch to dark theme' : 'Switch to light theme';
  }

  function applyTheme(pref){
    if(pref === 'light') root.classList.add('light');
    else root.classList.remove('light');
    updateButtonState(pref === 'light');
  }

  try {
    const stored = localStorage.getItem(STORAGE_KEY);
    if(stored === 'light' || stored === 'dark') applyTheme(stored);
    else if(window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) applyTheme('light');
  } catch (e) {
    // ignore storage access errors
  }

  // enable smooth transitions after initial paint
  requestAnimationFrame(()=>{
    setTimeout(()=> root.classList.add('theme-animated'), 80);
  });

  function doToggle(){
    const isLight = root.classList.toggle('light');
    try { localStorage.setItem(STORAGE_KEY, isLight ? 'light' : 'dark'); } catch (e) {}
    updateButtonState(isLight);
  }

  toggle.addEventListener('click', ()=> doToggle());
  toggle.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault();
      doToggle();
    }
  });
})();
</script>
