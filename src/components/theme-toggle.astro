---
// src/components/themeToggle.astro

const { ...props } = Astro.props;
---

<button class="theme-toggle" id="theme-toggle" type="button" aria-pressed="false" title="Toggle theme">
  <span class="sr-only">Toggle theme</span>
  <svg class="icon icon-moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
  <svg class="icon icon-sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>
</button>

<script is:inline type="module">
(function initThemeToggle(){
  const toggle = document.getElementById('theme-toggle');
  if (!toggle) { return; }
  const root = document.documentElement;
  const STORAGE_KEY = 'dl_theme';
  const ANIMATION_DELAY = 80;

  const updateButtonState = (isLight) => {
    toggle.setAttribute('aria-pressed', String(Boolean(isLight)));
    if (isLight) {
      toggle.title = 'Switch to dark theme';
    } else {
      toggle.title = 'Switch to light theme';
    }
  };

  const applyTheme = (pref) => {
    root.classList.toggle('light', pref === 'light');
    updateButtonState(pref === 'light');
  };

  try {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored === 'light' || stored === 'dark') {
      applyTheme(stored);
    } else if (globalThis.matchMedia && globalThis.matchMedia('(prefers-color-scheme: light)').matches) {
      applyTheme('light');
    }
  } catch {
    // ignore storage access errors
  }

  // enable smooth transitions after initial paint
  requestAnimationFrame(() => {
    setTimeout(() => root.classList.add('theme-animated'), ANIMATION_DELAY);
  });

  const doToggle = () => {
    const isLight = root.classList.toggle('light');
    try {
      if (isLight) {
        localStorage.setItem(STORAGE_KEY, 'light');
      } else {
        localStorage.setItem(STORAGE_KEY, 'dark');
      }
    } catch {
      // ignore storage errors
    }
    updateButtonState(isLight);
  };

  toggle.addEventListener('click', () => { doToggle(); });
  toggle.addEventListener('keydown', (event) => {
    if (event.key === 'Enter' || event.key === ' ') {
      event.preventDefault();
      doToggle();
    }
  });
})();
</script>
